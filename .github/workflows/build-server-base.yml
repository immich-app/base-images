name: Build and Push Server Base Images

on:
  push:
    tags:
      - "*"
    branches: [main]
  pull_request:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  packages: write

jobs:
  build_and_push:
    uses: immich-app/devtools/.github/workflows/multi-runner-build.yml@a6c9d08f2c3a5d7773ecc209cdde4b910d70cdb3
    strategy:
      fail-fast: true
      matrix:
        target: ["dev", "prod"]
    permissions:
      contents: read
      actions: read
      packages: write
    with:
      image: base-server-${{ matrix.target }}
      context: server
      dockerfile: server/Dockerfile
