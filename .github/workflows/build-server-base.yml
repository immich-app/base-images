name: Build and Push Server Base Images

on:
  push:
    tags:
      - "*"
    branches: [main]
  pull_request:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  packages: write

jobs:
  build_and_push:
    uses: immich-app/immich/.github/workflows/multi-runner-build.yml@41a127e2ab8d5c3bd130eeb8e342a8668582fe0b
    strategy:
      fail-fast: true
      matrix:
        target: ["dev", "prod"]
    permissions:
      contents: read
      actions: read
      packages: write
    with:
      image: base-server-${{ matrix.target }}
      context: server
      dockerfile: server/Dockerfile
